<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- KONFIGURASI SUPABASE ---
        // Ganti dengan URL dan Anon Key Supabase Anda
        const SUPABASE_URL = 'https://jjkponabjamzrmyoxdbt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impqa3BvbmFiamFtenJteW94ZGJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxODA3NjIsImV4cCI6MjA3Mzc1Njc2Mn0.riTxNL9C_AQBG0-FJJ_VIgmBNHFkOtgdvc6dvJuALUQ';

        // Inisialisasi Supabase Client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
    <title>Daily Work Log - Social Media Specialist</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #f5f7fa;
            --card-bg-color: #fff;
            --text-color: #333;
            --border-color: #dfe3e8;
            --input-bg-color: #fff;
            --header-bg-color: #f5f7fa;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --primary-color: #4a90e2;
            --secondary-color: #6c757d;
            --success-color: #34c759;
            --danger-color: #ff3b30;
            --warning-color: #ff9500;
            --info-color: #007bff; /* Warna biru yang lebih kontras */
            --white-color: #fff;
        }

        html[data-theme='dark'] {
            --bg-color: #121212;
            --card-bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333;
            --input-bg-color: #2a2a2a;
            --header-bg-color: #1e1e1e;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background-color: var(--card-bg-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background-color 0.3s;
        }

        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin: 0;
        }

        #theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-color);
        }

        .form-container {
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        label {
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }

        input[type="date"],
        select,
        textarea,
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1em;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            box-sizing: border-box;
            transition: border-color 0.2s, background-color 0.3s;
        }

        input[type="date"]:focus,
        select:focus,
        textarea:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .drop-zone {
            border: 2px dashed var(--border-color);
            background-color: var(--bg-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        #auth-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #user-profile img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }
        #user-profile span {
            font-weight: 600;
        }
        #login-btn, #logout-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            background-color: #357abd;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color); /* Dark gray */
            color: var(--white-color);
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success-color);
            color: var(--white-color);
        }
        .btn-success:hover { background-color: #2da44e; }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-controls select, .filter-controls input {
            width: 100%;
        }

        .table-container {
            margin-top: 30px;
        }

        .table-controls {
            margin-bottom: 15px;
        }

        #search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--header-bg-color);
            font-weight: 600;
        }

        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 700;
            color: var(--white-color);
            text-align: center;
            display: inline-block;
        }

        .status-plan { background-color: var(--warning-color); }
        .status-progress { background-color: var(--primary-color); }
        .status-done { background-color: var(--success-color); }

        .log-image-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }

        .tag-badge {
            display: inline-block;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            border: 1px solid var(--border-color);
            margin: 2px;
            transition: background-color 0.2s;
        }
        .tag-badge.active {
            background-color: var(--primary-color);
            color: var(--white-color);
            border-color: var(--primary-color);
        }

        .action-buttons .btn {
            padding: 5px 10px;
            font-size: 0.9em;
            margin-right: 5px;
        }

        .btn-view {
            background-color: var(--info-color);
            color: var(--white-color);
        }
        .btn-view:hover { background-color: #0069d9; }

        .btn-edit {
            background-color: var(--warning-color);
            color: var(--white-color);
        }
        .btn-edit:hover { background-color: #e68600; }

        .btn-delete {
            background-color: var(--danger-color);
            color: var(--white-color);
        }
        .btn-delete:hover { background-color: #d92c2c; }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: var(--white-color);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        .alert.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .alert-success { background-color: var(--success-color); }
        .alert-danger { background-color: var(--danger-color); }
        .alert-info { background-color: var(--primary-color); }

        .truncated-text {
            max-height: 3.2em; /* Sekitar 2 baris */
            overflow: hidden;
            position: relative;
            line-height: 1.6em;
        }
        .truncated-text.expanded {
            max-height: none;
        }
        .toggle-text {
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
        }
        .toggle-text:hover {
            text-decoration: underline;
        }

        #image-modal {
            display: none;
            position: fixed;
            z-index: 3000; /* Harus lebih tinggi dari z-index modal lain */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        #modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .modal-nav {
            cursor: pointer;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 50px;
            font-weight: bold;
            padding: 16px;
            user-select: none;
            transition: 0.3s;
            z-index: 3001;
        }
        .modal-nav:hover {
            background-color: rgba(0,0,0,0.3);
        }
        .modal-nav.prev { left: 10px; }
        .modal-nav.next { right: 10px; }
        .modal-nav.hidden { display: none; }

        #close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 3002;
        }

        #image-preview-container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .preview-image-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .preview-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
        }
        .remove-image-btn {
            position: absolute; top: -8px; right: -8px;
            background: var(--danger-color); color: white;
            border-radius: 50%; width: 22px; height: 22px;
            border: none; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            line-height: 1;
        }

        /* JSONBin Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--card-bg-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px var(--shadow-color);
            width: 90%;
            max-width: 500px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .instructions-container {
            margin-top: 25px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
            font-size: 0.9em;
            color: var(--text-muted);
        }
        .instructions-container h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        .instructions-container ol { padding-left: 20px; }
        .instructions-container code {
            background-color: var(--bg-color);
            padding: 2px 5px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-family: monospace;
        }
        
        /* Preview Modal Styles */
        #preview-modal .modal-content {
            max-width: 800px;
        }
        #preview-content {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 15px;
        }
        #preview-content h3 { margin-top: 0; }
        #preview-content .ql-editor {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 12px;
            background-color: var(--bg-color);
        }
        #preview-notes {
            white-space: pre-wrap; background-color: var(--bg-color); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); margin-bottom: 15px;
        }
        #preview-images img:hover {
            opacity: 0.8; cursor: pointer;
        }
        #preview-images img {
            max-width: 150px; margin: 5px; border-radius: 5px;
        }

        /* Quill Editor Styles */
        .ql-editor {
            min-height: 150px;
            font-size: 1em;
            line-height: 1.6;
            color: var(--text-color);
        }
        .ql-toolbar.ql-snow, .ql-container.ql-snow {
            border-color: var(--border-color);
        }
        .ql-snow .ql-stroke { stroke: var(--text-color); }
        .ql-snow .ql-fill { fill: var(--text-color); }

        /* Mobile Responsive */
        @media (max-width: 960px) {
            .header-main {
                flex-direction: column;
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .btn {
                width: 100%;
            }

            table, thead, tbody, th, td, tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 5px;
                padding: 10px;
            }

            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }

            td:before {
                position: absolute;
                top: 12px;
                left: 15px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
            }

            td:last-child {
                border-bottom: 0;
            }
            
            .action-buttons {
                text-align: right;
            }
        }
    </style>
</head>
<body>

    <div id="alert-container"></div>

    <div id="image-modal">
        <span id="close-modal">&times;</span>
        <span class="modal-nav prev hidden" id="modal-prev-btn">&lt;</span>
        <img id="modal-image">
        <span class="modal-nav next hidden" id="modal-next-btn">&gt;</span>
    </div>

    <div class="container">
        <div class="header-main">
            <h1>Daily Work Log</h1>
            <button id="theme-toggle" title="Ganti Mode">🌙</button>
        </div>

        <div class="form-container">
            <form id="work-log-form" class="drop-zone-target">
                <input type="hidden" id="log-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="log-date">Tanggal</label>
                        <input type="date" id="log-date" required>
                    </div>
                    <div class="form-group">
                        <label for="log-platform">Platform</label>
                        <select id="log-platform" required>
                            <!-- Options will be added by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="log-status">Status Pekerjaan</label>
                        <select id="log-status" required>
                            <option value="Plan">Plan</option>
                            <option value="Progress">Progress</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="log-activity">Aktivitas</label>
                        <div id="quill-editor"></div>
                    </div>
                    <div class="form-group full-width">
                        <label for="log-notes">Catatan Tambahan (Link/Insight)</label>
                        <textarea id="log-notes" rows="2" placeholder="Contoh: Link konten: https://... atau Insight: Engagement rate naik 5%..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="log-tags">Tags (pisahkan dengan koma)</label>
                        <input type="text" id="log-tags" placeholder="Contoh: campaign, qna, promo">
                    </div>
                    <div class="form-group full-width">
                        <label>Gambar (Opsional)</label>
                        <div id="image-preview-container">
                            <!-- Image previews will be added here by JS -->
                        </div>
                        <small class="muted" style="margin-top: 5px;">Anda bisa paste (CTRL+V) atau drag & drop gambar ke area form.</small>
                    </div>
                </div>
                <div class="button-group" style="justify-content: space-between; gap: 20px;">
                    <!-- Grup Tombol Kiri: Aksi Utama & Lokal -->
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button type="submit" class="btn btn-primary" id="submit-button">Tambah Log</button>
                        <div style="display: flex; gap: 5px; border-left: 2px solid var(--border-color); padding-left: 10px;">
                            <button type="button" class="btn btn-secondary" id="export-xlsx" title="Export ke Excel">XLSX</button>
                            <button type="button" class="btn btn-secondary" id="export-json-local-btn" title="Export ke File JSON">JSON</button>
                            <button type="button" class="btn btn-success" id="import-json-local-btn" title="Import dari File JSON">Import</button>
                        </div>
                        <div style="display: flex; gap: 5px; border-left: 2px solid var(--border-color); padding-left: 10px;">
                            <button type="button" class="btn btn-secondary" id="export-firestore-btn" disabled title="Simpan ke Cloud">Simpan Cloud</button>
                            <button type="button" class="btn btn-success" id="import-firestore-btn" disabled title="Muat dari Cloud">Muat Cloud</button>
                        </div>
                    </div>

                    <!-- Grup Tombol Kanan: Auth & Reset -->
                    <div id="auth-container">
                        <div id="user-profile" class="hidden">
                            <img id="user-pic" src="" alt="User photo">
                            <span id="user-name"></span>
                        </div>
                        <button id="login-btn" class="btn">Login Google</button>
                        <button id="logout-btn" class="btn btn-danger hidden" title="Logout">Logout</button>
                        <button type="button" class="btn btn-danger" id="reset-all-btn" title="Reset Semua Data">Reset</button>
                    </div>
                    <span id="sync-status" style="font-size: 0.85em; color: var(--text-muted); align-self: center;"></span>
                    <input type="file" id="json-file-input" accept=".json" style="display: none;">
                </div>
            </form>
        </div>

        <div class="table-container">
            <div class="table-controls">
                <div class="filter-controls">
                    <input type="search" id="search-input" placeholder="Cari aktivitas, catatan, tag...">
                    <select id="filter-status">
                        <option value="all">Semua Status</option>
                        <option value="Plan">Plan</option>
                        <option value="Progress">Progress</option>
                        <option value="Done">Done</option>
                    </select>
                    <select id="filter-platform">
                        <!-- Options will be added by JS -->
                    </select>
                    <select id="filter-timeframe">
                        <option value="all">Semua Waktu</option>
                        <option value="week">Minggu Ini</option>
                        <option value="month">Bulan Ini</option>
                        <option value="year">Tahun Ini</option>
                    </select>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <label for="filter-start-date" style="font-size: 0.9em; margin-bottom: 0;">Dari:</label>
                        <input type="date" id="filter-start-date" style="padding: 8px;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <label for="filter-end-date" style="font-size: 0.9em; margin-bottom: 0;">Sampai:</label>
                        <input type="date" id="filter-end-date" style="padding: 8px;">
                    </div>
                    <select id="sort-order">
                        <option value="desc">Urutkan: Terbaru ke Terlama</option>
                        <option value="asc">Urutkan: Terlama ke Terbaru</option>
                    </select>
                </div>
                <div class="pagination-controls" style="margin-top: 20px; display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                    <div>
                        <label for="limit-select" style="font-size: 0.9em; margin-bottom: 0;">Tampilkan:</label>
                        <select id="limit-select" style="padding: 8px; width: auto;">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="all">Semua</option>
                        </select>
                    </div>
                    <div id="pagination-nav" style="display: flex; gap: 10px;">
                        <button id="prev-page" class="btn btn-secondary" style="padding: 5px 10px;">&laquo; Prev</button>
                        <span id="page-info" style="align-self: center; font-size: 0.9em;"></span>
                        <button id="next-page" class="btn btn-secondary" style="padding: 5px 10px;">Next &raquo;</button>
                    </div>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="log-table">
                    <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Aktivitas</th>
                        <th>Status</th>
                        <th>Catatan</th>
                        <th>Tags</th>
                        <th>Gambar</th>
                        <th>Aksi</th>
                    </tr>
                    </thead>
                    <tbody id="log-table-body">
                        <!-- Data log akan ditampilkan di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="preview-title">Detail Log</h2>
                <span id="close-preview-modal" style="cursor: pointer; font-size: 24px;">&times;</span>
            </div>
            <div id="preview-content">
                <p><strong>Tanggal:</strong> <span id="preview-date"></span></p>
                <p><strong>Platform:</strong> <span id="preview-platform"></span></p>
                <p style="margin-bottom: 5px;"><strong>Aktivitas:</strong></p>
                <div id="preview-activity" class="ql-snow"><div class="ql-editor"></div></div>
                <p style="margin-top: 15px; margin-bottom: 5px;"><strong>Catatan Tambahan:</strong></p>
                <div id="preview-notes"></div>
                <div id="preview-images" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
    <script>
        // Load Quill dynamically
        const quillCss = document.createElement('link'); quillCss.rel = 'stylesheet'; quillCss.href = 'https://cdn.quilljs.com/1.3.6/quill.snow.css'; document.head.appendChild(quillCss);
        const quillJs = document.createElement('script'); quillJs.src = 'https://cdn.quilljs.com/1.3.6/quill.min.js'; quillJs.onload = () => document.dispatchEvent(new Event('quillLoaded')); document.head.appendChild(quillJs);

        document.addEventListener('DOMContentLoaded', () => {
            // All application logic is now safely inside DOMContentLoaded

            const form = document.getElementById('work-log-form');
            const formContainer = document.querySelector('.form-container');
            const logIdInput = document.getElementById('log-id');
            const logDateInput = document.getElementById('log-date');
            const logPlatformInput = document.getElementById('log-platform');
            const logStatusInput = document.getElementById('log-status');
            const logNotesInput = document.getElementById('log-notes');
            const logTagsInput = document.getElementById('log-tags');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const tableBody = document.getElementById('log-table-body'); 
            const submitButton = document.getElementById('submit-button');
            const exportXlsxButton = document.getElementById('export-xlsx');
            const exportJsonLocalBtn = document.getElementById('export-json-local-btn');
            const importJsonLocalBtn = document.getElementById('import-json-local-btn');
            const exportFirestoreBtn = document.getElementById('export-firestore-btn');
            const importFirestoreBtn = document.getElementById('import-firestore-btn');
            const jsonFileInput = document.getElementById('json-file-input');
            const searchInput = document.getElementById('search-input');
            const filterStatus = document.getElementById('filter-status');
            const filterTimeframe = document.getElementById('filter-timeframe');
            const filterPlatform = document.getElementById('filter-platform');
            const filterStartDate = document.getElementById('filter-start-date');
            const filterEndDate = document.getElementById('filter-end-date');
            const sortOrderSelect = document.getElementById('sort-order');
            const limitSelect = document.getElementById('limit-select');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const pageInfo = document.getElementById('page-info');
            const paginationNav = document.getElementById('pagination-nav');
            const imageModal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const themeToggle = document.getElementById('theme-toggle');
            const resetAllBtn = document.getElementById('reset-all-btn');
            const closeModal = document.getElementById('close-modal');
            const modalPrevBtn = document.getElementById('modal-prev-btn');
            const modalNextBtn = document.getElementById('modal-next-btn');
            const syncStatus = document.getElementById('sync-status');            
            const previewModal = document.getElementById('preview-modal');
            const closePreviewModal = document.getElementById('close-preview-modal');

            let currentPage = 1;
            let activeFilterTags = new Set();
            let currentFormImages = [];
            const PLATFORMS = ["Instagram", "TikTok", "Facebook", "X / Twitter", "LinkedIn", "Website/Blog", "Lainnya"];
            let quill;
            
            // Supabase variables
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            // Set tanggal default ke hari ini
            logDateInput.valueAsDate = new Date();

            // Populate platform dropdowns
            const populatePlatformSelects = () => {
                const selects = [logPlatformInput, filterPlatform];
                selects.forEach(select => {
                    if (select === filterPlatform) {
                        select.innerHTML = '<option value="all">Semua Platform</option>';
                    } else {
                        select.innerHTML = '';
                    }
                    PLATFORMS.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`);
                });
            };
            populatePlatformSelects();

            window.getLogs = () => JSON.parse(localStorage.getItem('workLogs')) || [];
            window.saveLogs = (logs) => localStorage.setItem('workLogs', JSON.stringify(logs));

            window.filterLogs = (logs) => {
                const searchTerm = searchInput.value.toLowerCase();
                const status = filterStatus.value;
                const platform = filterPlatform.value;
                const timeframe = filterTimeframe.value;
                const startDate = filterStartDate.value;
                const endDate = filterEndDate.value;
                const now = new Date();

                return logs.filter(log => {
                    // Filter by Status
                    if (status !== 'all' && log.status !== status) {
                        return false;
                    }

                    // Filter by Platform
                    if (platform !== 'all' && log.platform !== platform) {
                        return false;
                    }

                    // Filter by Timeframe
                    // Normalisasi tanggal untuk menghindari masalah timezone
                    const logDateParts = log.date.split('-').map(Number);
                    const logDate = new Date(logDateParts[0], logDateParts[1] - 1, logDateParts[2]);

                    if (startDate && endDate) {
                        const startParts = startDate.split('-').map(Number);
                        const endParts = endDate.split('-').map(Number);
                        const start = new Date(startParts[0], startParts[1] - 1, startParts[2]);
                        const end = new Date(endParts[0], endParts[1] - 1, endParts[2]);
                        if (logDate < start || logDate > end) return false;
                    }
                    else if (timeframe !== 'all') {
                        if (timeframe === 'year' && logDate.getFullYear() !== now.getFullYear()) return false;
                        if (timeframe === 'month' && (logDate.getMonth() !== now.getMonth() || logDate.getFullYear() !== now.getFullYear())) return false;
                        if (timeframe === 'week') {
                            const startOfWeek = new Date(now);
                            startOfWeek.setDate(now.getDate() - now.getDay());
                            startOfWeek.setHours(0, 0, 0, 0);
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6);
                            endOfWeek.setHours(23, 59, 59, 999);
                            if (logDate < startOfWeek || logDate > endOfWeek) return false;
                        }
                    }

                    // Filter by Search Term
                    if (searchTerm) {
                        const searchInTags = log.tags ? log.tags.some(tag => tag.toLowerCase().includes(searchTerm)) : false;
                        const searchInText = (
                            (log.activity || '').toLowerCase().includes(searchTerm) ||
                            (log.notes || '').toLowerCase().includes(searchTerm) ||
                            (log.platform || '').toLowerCase().includes(searchTerm)
                        );
                        if (!searchInTags && !searchInText) return false;
                    }
                    
                    return true;
                });
            };

            window.renderTable = async () => {
                const allLogs = getLogs();
                tableBody.innerHTML = '';
                const filteredLogs = filterLogs(allLogs);
                if (filteredLogs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Tidak ada data yang cocok dengan filter.</td></tr>';
                    paginationNav.style.display = 'none'; // Sembunyikan navigasi jika tidak ada data sama sekali
                    return; // Hentikan eksekusi jika tidak ada log yang cocok sama sekali
                }

                // Sorting
                const sortOrder = sortOrderSelect.value;
                filteredLogs.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });

                // Pagination
                const limit = limitSelect.value;
                const totalLogs = filteredLogs.length;
                const totalPages = limit === 'all' ? 1 : Math.ceil(totalLogs / limit);
                
                if (currentPage > totalPages) {
                    currentPage = totalPages || 1;
                }

                const startIndex = limit === 'all' ? 0 : (currentPage - 1) * limit;
                const endIndex = limit === 'all' ? totalLogs : startIndex + limit;
                const paginatedLogs = filteredLogs.slice(startIndex, endIndex);

                if (limit === 'all') {
                    paginationNav.style.display = 'none';
                } else {
                    paginationNav.style.display = 'flex';
                    pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
                    prevPageBtn.disabled = currentPage === 1;
                    nextPageBtn.disabled = currentPage === totalPages;
                }

                const createTruncatedCell = (text, maxLength = 100) => {
                    if (!text || text.length <= maxLength) { // Jika teks pendek atau tidak ada
                        return text || '-';
                    }
                    const uniqueId = `text-${Date.now()}-${Math.random()}`;
                    return `<div id="${uniqueId}" class="truncated-text">${text}</div><span class="toggle-text" onclick="toggleText('${uniqueId}', this)">show more</span>`;
                };

                paginatedLogs.forEach(log => {
                    const tr = document.createElement('tr');
                    const imageHtml = log.images && log.images.length > 0
                        ? log.images.map((img, index) => `<img src="${img}" alt="Log Image" class="log-image-thumb" onclick='showImageModal(${JSON.stringify(JSON.stringify(log.images))}, ${index})'>`).join('')
                        : '-';

                    const activityContent = createTruncatedCell(log.activity);
                    const notesContent = createTruncatedCell(log.notes);
                    const tagsHtml = log.tags && log.tags.length > 0
                        ? log.tags.map(tag => {
                            const isActive = activeFilterTags.has(tag);
                            return `<span class="tag-badge ${isActive ? 'active' : ''}" style="cursor: pointer;" onclick="toggleTagFilter('${tag}')">${tag}</span>`;
                        })
                        .join('')
                        : '-';

                    const previewButton = `<button class="btn btn-view" onclick="handlePreview('${log.id}')">Preview</button>`;

                    const actionButtons = `
                        <div class="action-buttons">
                            <button class="btn btn-edit" onclick="handleEdit('${log.id}')">Edit</button>
                            <button class="btn btn-delete" onclick="handleDelete('${log.id}')">Delete</button>
                        </div>
                    `;

                    tr.innerHTML = `
                        <td data-label="Tanggal">${log.date}</td>
                        <td data-label="Aktivitas">
                            <strong>${log.platform}</strong><br>
                            ${activityContent}
                        </td>
                        <td data-label="Status"><span class="status status-${log.status.toLowerCase()}">${log.status}</span></td>
                        <td data-label="Catatan">${notesContent}</td>
                        <td data-label="Tags">${tagsHtml}</td>
                        <td data-label="Gambar">${imageHtml}</td>
                        <td data-label="Aksi"><div class="action-buttons">
                            <button class="btn btn-view" onclick="handlePreview('${log.id}')">Preview</button>
                            <button class="btn btn-edit" onclick="handleEdit('${log.id}')">Edit</button>
                            <button class="btn btn-delete" onclick="handleDelete('${log.id}')">Delete</button></div></td>
                    `;
                    tableBody.appendChild(tr);
                });
            };

            window.showAlert = (message, type = 'success') => {
                const alertContainer = document.getElementById('alert-container');
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.textContent = message;
                alertContainer.appendChild(alertDiv);

                setTimeout(() => alertDiv.classList.add('show'), 10);
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 300);
                }, 3000);
            };

            window.resetForm = () => {
                form.reset();
                logIdInput.value = '';
                quill.setText(''); // Clear Quill editor
                submitButton.textContent = 'Tambah Log';
                submitButton.classList.remove('btn-warning');
                submitButton.classList.add('btn-primary');
                currentFormImages = [];
                renderImagePreviews();
            };

            window.clearFormForNewEntry = () => {
                logIdInput.value = '';
                logPlatformInput.selectedIndex = 0;
                logStatusInput.selectedIndex = 0;
                logNotesInput.value = '';
                logTagsInput.value = '';
                currentFormImages = [];
                renderImagePreviews();
                submitButton.textContent = 'Tambah Log';
                submitButton.classList.remove('btn-warning');
                submitButton.classList.add('btn-primary');
            };

            window.compressImage = (file, quality = 0.7, maxWidth = 800) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            if (width > maxWidth) {
                                height = (maxWidth / width) * height;
                                width = maxWidth;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = (error) => reject(error);
                    };
                    reader.onerror = (error) => reject(error);
                });
            };

            window.renderImagePreviews = () => {
                imagePreviewContainer.innerHTML = '';
                currentFormImages.forEach((imgSrc, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'preview-image-wrapper';
                    wrapper.innerHTML = `
                        <img src="${imgSrc}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-image-btn" data-index="${index}">&times;</button>
                    `;
                    imagePreviewContainer.appendChild(wrapper);
                });
            };

            imagePreviewContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-image-btn')) {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    currentFormImages.splice(indexToRemove, 1);
                    renderImagePreviews();
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Tambahkan pengecekan untuk memastikan Quill sudah siap
                if (!quill) {
                    showAlert('Editor belum siap, mohon tunggu beberapa saat.', 'danger');
                    return;
                }

                const logData = {
                    id: logIdInput.value || Date.now().toString(),
                    date: logDateInput.value,
                    platform: logPlatformInput.value,
                    activity: quill.root.innerHTML, // Get HTML content from Quill
                    status: logStatusInput.value,
                    notes: logNotesInput.value.trim(),
                    tags: logTagsInput.value.split(/\s+/).map(tag => tag.trim()).filter(tag => tag),
                    images: [...currentFormImages]
                };

                // Validate Quill content by checking its text length
                if (!logData.date || quill.getText().trim().length === 0 || !logData.status || !logData.platform) {
                    showAlert('Field Tanggal, Platform, Aktivitas, dan Status tidak boleh kosong.', 'danger');
                    return;
                }

                let logs = getLogs(); 
                const existingLogIndex = logs.findIndex(log => log.id === logData.id);

                if (existingLogIndex > -1) {
                    logs[existingLogIndex] = logData;
                    showAlert('Log berhasil diperbarui!', 'info');
                } else {
                    logs.push(logData);
                    showAlert('Log baru berhasil ditambahkan!');
                }

                currentPage = 1; // Selalu kembali ke halaman pertama setelah menambah/update
                saveLogs(logs);
                renderTable();
                resetForm();
            });

            window.handleEdit = (id) => { const logs = getLogs();
                const logToEdit = logs.find(log => log.id === id);
                if (logToEdit) {
                    logIdInput.value = logToEdit.id;
                    logDateInput.value = logToEdit.date;
                    logPlatformInput.value = logToEdit.platform; 
                    quill.root.innerHTML = logToEdit.activity; // Set Quill content
                    logStatusInput.value = logToEdit.status;
                    logNotesInput.value = logToEdit.notes;
                    logTagsInput.value = logToEdit.tags ? logToEdit.tags.join(' ') : '';
                    currentFormImages = logToEdit.images ? [...logToEdit.images] : [];
                    renderImagePreviews();
                    submitButton.textContent = 'Update Log';
                    submitButton.classList.remove('btn-primary');
                    submitButton.classList.add('btn-warning');
                    window.scrollTo(0, 0);
                }
            };

            window.handlePreview = (id) => {
                const log = getLogs().find(l => l.id === id);
                if (!log) return;

                document.getElementById('preview-title').textContent = `Detail Log: ${log.date}`;
                document.getElementById('preview-date').textContent = log.date;
                document.getElementById('preview-platform').textContent = log.platform;
                document.querySelector('#preview-activity .ql-editor').innerHTML = log.activity;
                const notesDiv = document.getElementById('preview-notes');
                notesDiv.textContent = log.notes || 'Tidak ada catatan.';
                notesDiv.style.display = log.notes ? 'block' : 'none';
                notesDiv.previousElementSibling.style.display = log.notes ? 'block' : 'none';
                
                const imagesContainer = document.getElementById('preview-images');
                imagesContainer.innerHTML = log.images && log.images.length > 0
                    ? log.images.map((src, index) => `<img src="${src}" alt="Log image" onclick='showImageModal(${JSON.stringify(JSON.stringify(log.images))}, ${index})'>`).join('')
                    : '<p><em>Tidak ada gambar.</em></p>';

                previewModal.style.display = 'flex';
            };

            // Fungsi untuk export data ke XLSX (Excel)
            exportXlsxButton.addEventListener('click', () => {
                const logs = getLogs();
                if (logs.length === 0) {
                    showAlert('Tidak ada data untuk diexport.', 'info');
                    return;
                }

                // 1. Siapkan data dengan header yang lebih deskriptif
                const dataForExport = logs.map(log => ({
                    'Tanggal': log.date,
                    'Platform': log.platform,
                    'Aktivitas': log.activity,
                    'Status': log.status,
                    'Catatan': log.notes,
                    'Tags': log.tags ? log.tags.join(', ') : '',
                    'Jumlah Gambar': log.images ? log.images.length : 0
                }));

                // 2. Buat worksheet dari data JSON
                const worksheet = XLSX.utils.json_to_sheet(dataForExport);
                // 3. Buat workbook baru
                const workbook = XLSX.utils.book_new();
                // 4. Tambahkan worksheet ke workbook
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Work Logs');

                // 5. Trigger download file XLSX
                const today = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(workbook, `work_log_${today}.xlsx`);

                showAlert('Data berhasil diexport ke XLSX.', 'success');
            });

            // Fungsi untuk export data ke JSON lokal
            const exportJsonLocal = () => {
                const logs = getLogs();
                if (logs.length === 0) {
                    showAlert('Tidak ada data untuk diexport.', 'info');
                    return;
                }

                const jsonString = JSON.stringify({ logs: logs }, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });

                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `work_log_backup_${new Date().toISOString().slice(0, 10)}.json`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert('Data berhasil diexport ke file JSON lokal.', 'info');
            };

            exportJsonLocalBtn.addEventListener('click', exportJsonLocal);

            window.handleDelete = async (id) => {
                if (confirm('Apakah Anda yakin ingin menghapus log ini?')) {
                    let logs = getLogs();
                    logs = logs.filter(log => log.id !== id);
                    saveLogs(logs);                    
                    renderTable(); 
                    showAlert('Log berhasil dihapus.', 'danger');
                }
            };

            // Memicu file input saat tombol import lokal di-klik
            importJsonLocalBtn.addEventListener('click', () => {
                jsonFileInput.click();
            });

            // Fungsi untuk memuat data dari file JSON
            jsonFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (confirm('Memuat file ini akan menimpa semua data yang ada. Lanjutkan?')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Handle both raw array and {logs: [...]} object
                        const data = JSON.parse(e.target.result);
                        const logs = Array.isArray(data) ? data : data.logs || [];
                        saveLogs(logs);
                        renderTable();
                        showAlert('Data berhasil dimuat dari file JSON!', 'success');
                    };
                    reader.readAsText(file);
                }
                // Reset file input agar bisa load file yang sama lagi
                event.target.value = null;
            });

            resetAllBtn.addEventListener('click', () => {
                if (confirm('PERINGATAN: Aksi ini akan menghapus SEMUA data log secara permanen. Apakah Anda benar-benar yakin?')) {
                    localStorage.removeItem('workLogs');
                    currentPage = 1;
                    renderTable();
                    showAlert('Semua data berhasil direset.', 'danger');
                }
            });

            // Fungsi ini akan dipanggil oleh initClient atau saat DOMContentLoaded
            let modalImages = [];
            let currentModalImageIndex = 0;

            window.showImageModal = (imagesJson, index) => {
                modalImages = JSON.parse(imagesJson);
                currentModalImageIndex = index;
                updateModalImage();
                modalPrevBtn.classList.toggle('hidden', modalImages.length <= 1);
                modalNextBtn.classList.toggle('hidden', modalImages.length <= 1);
                imageModal.style.display = 'flex';
            };

            const updateModalImage = () => {
                if (modalImages.length > 0) {
                    modalImage.src = modalImages[currentModalImageIndex];
                }
            };

            const showNextImage = () => {
                currentModalImageIndex = (currentModalImageIndex + 1) % modalImages.length;
                if (modalImages.length === 0) return;
                updateModalImage();
            };

            const showPrevImage = () => {
                currentModalImageIndex = (currentModalImageIndex - 1 + modalImages.length) % modalImages.length;
                if (modalImages.length === 0) return;
                updateModalImage();
            };

            // Simple next/prev on modal click for now
            modalImage.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent modal from closing
                showNextImage();
            });

            modalPrevBtn.addEventListener('click', showPrevImage);
            modalNextBtn.addEventListener('click', showNextImage);

            closeModal.addEventListener('click', () => {
                imageModal.style.display = 'none';
            });

            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) { // Hanya tutup jika klik di area background
                    imageModal.style.display = 'none';
                }
            });

            // Event listeners untuk menutup modal preview
            closePreviewModal.addEventListener('click', () => {
                previewModal.style.display = 'none';
            });

            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal) {
                    previewModal.style.display = 'none';
                }
            });

            window.toggleText = (elementId, button) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList.toggle('expanded');
                    if (element.classList.contains('expanded')) {
                        button.textContent = 'show less';
                    } else {
                        button.textContent = 'show more';
                    }
                }
            };

            logDateInput.addEventListener('change', clearFormForNewEntry);

            searchInput.addEventListener('input', renderTable);
            filterStatus.addEventListener('change', renderTable);
            filterTimeframe.addEventListener('change', renderTable);
            filterStartDate.addEventListener('change', renderTable);
            filterEndDate.addEventListener('change', renderTable);
            filterPlatform.addEventListener('change', renderTable);
            sortOrderSelect.addEventListener('change', renderTable);
            limitSelect.addEventListener('change', () => {
                currentPage = 1;
                renderTable();
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                currentPage++;
                renderTable();
            });

            // Theme Toggle
            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                themeToggle.textContent = theme === 'dark' ? '☀️' : '🌙';
                localStorage.setItem('theme', theme);
            };

            themeToggle.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            });

            // Paste image from clipboard
            document.addEventListener('paste', async (e) => {
                const items = e.clipboardData.items;
                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        const compressedImage = await compressImage(file);
                        currentFormImages.push(compressedImage);
                        renderImagePreviews();
                        showAlert('Gambar berhasil di-paste!', 'info');
                    }
                }
            });

            window.toggleTagFilter = (tag) => {
                if (activeFilterTags.has(tag)) {
                    activeFilterTags.delete(tag);
                } else {
                    activeFilterTags.add(tag);
                }
                // Sync search input with active tags
                searchInput.value = Array.from(activeFilterTags).join(' ');
                renderTable();
            };

            // Drag and drop image functionality
            const setupDragAndDrop = () => {
                const dropZone = formContainer;

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.add('drop-zone');
                });

                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('drop-zone');
                });

                dropZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('drop-zone');

                    const files = e.dataTransfer.files;
                    let imageAdded = false;
                    for (const file of files) {
                        if (file.type.startsWith('image/')) {
                            const compressedImage = await compressImage(file);
                            currentFormImages.push(compressedImage);
                            imageAdded = true;
                        }
                    }
                    if (imageAdded) {
                        renderImagePreviews();
                        showAlert('Gambar berhasil ditambahkan via drag & drop!', 'info');
                    }
                });
            };

            window.updateSyncStatus = (message, type) => {
                syncStatus.textContent = message;
                syncStatus.style.color = `var(--${type}-color)`;
            };

            const initializeApp = async () => {
                // Initialize Quill
                quill = new Quill('#quill-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'align': [] }],
                            ['link'],
                            ['clean']
                        ]
                    }
                });

                setupDragAndDrop();
                renderTable(); // Render table with local or synced data
            };

            // Expose necessary functions to the window object so they can be called from inline HTML event handlers
            window.toggleText = toggleText;
            window.toggleTagFilter = toggleTagFilter;
            window.handleEdit = handleEdit;
            window.handleDelete = handleDelete;
            window.handlePreview = handlePreview;
            window.showImageModal = showImageModal;

            // Initialize the app once Quill is loaded
            document.addEventListener('quillLoaded', initializeApp);

            // --- Supabase Authentication and Database Logic ---

            // Listen for auth state changes
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                const userProfile = document.getElementById('user-profile');
                if (session?.user) {
                    // User is signed in
                    const user = session.user;
                    userProfile.classList.remove('hidden');
                    loginBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    document.getElementById('user-name').textContent = user.user_metadata.full_name;
                    document.getElementById('user-pic').src = user.user_metadata.avatar_url;
                    exportFirestoreBtn.disabled = false;
                    importFirestoreBtn.disabled = false;
                    updateSyncStatus(`Login sebagai ${user.user_metadata.full_name}`, 'success');
                    await loadLogsFromFirestore(); // Automatically load data on login
                } else {
                    // User is signed out
                    userProfile.classList.add('hidden');
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    exportFirestoreBtn.disabled = true;
                    importFirestoreBtn.disabled = true;
                    updateSyncStatus('Anda belum login.', 'warning');
                    saveLogs([]); // Clear local data on logout
                    renderTable();
                }
            });

            // Sign in with Google
            loginBtn.addEventListener('click', async () => {
                const { error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                });
                if (error) {
                    console.error("Login error:", error);
                    showAlert(`Login gagal: ${error.message}`, 'danger');
                }
            });

            // Sign out
            logoutBtn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
            });

            // Save logs to Supabase
            const saveLogsToFirestore = async () => {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    showAlert('Anda harus login untuk menyimpan data ke cloud.', 'danger');
                    return;
                }
                updateSyncStatus('Menyimpan ke cloud...', 'info');
                const logs = getLogs();
                const { error } = await supabaseClient.from('worklogs').upsert({ id: user.id, logs: logs });

                if (error) {
                    console.error("Supabase save error:", error);
                    updateSyncStatus('Gagal menyimpan ke cloud.', 'danger');
                    showAlert(`Gagal menyimpan: ${error.message}`, 'danger');
                } else {
                    updateSyncStatus('Data berhasil disimpan di cloud.', 'success');
                    showAlert('Data berhasil disimpan di cloud!', 'success');
                }
            };

            // Load logs from Supabase
            const loadLogsFromFirestore = async () => {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;
                updateSyncStatus('Memuat data dari cloud...', 'info');
                const { data, error } = await supabaseClient.from('worklogs').select('logs').eq('id', user.id).single();
                const logs = data ? data.logs : [];
                saveLogs(logs);
                renderTable();
                updateSyncStatus('Data cloud berhasil dimuat.', 'success');
            };

            exportFirestoreBtn.addEventListener('click', saveLogsToFirestore);
            importFirestoreBtn.addEventListener('click', loadLogsFromFirestore);
        });
    </script>
</body>
</html>
