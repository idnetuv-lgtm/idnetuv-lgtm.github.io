<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Social Media Insight Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #fff; color: #111; }
    h3 { margin-bottom: 10px; }
    .content { border: 1px solid #000; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
    .form-row { display: flex; align-items: center; margin: 8px 0; }
    .form-row label { flex: 1; }
    .form-row input, .form-row select, .form-row textarea { flex: 2; padding: 6px; border: 1px solid #000; border-radius: 4px; }
    button { margin: 6px; padding: 6px 12px; background: #000; color: #fff; border: none; cursor: pointer; border-radius: 6px; font-size: 14px; }
    button:hover { background: #949494; opacity: 0.8; }
    canvas { max-width: 700px; margin-top: 20px; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; font-size: 14px; }
    table, th, td { border: 1px solid #000; }
    th, td { padding: 6px; text-align: center; }
    .collapsible { cursor: pointer; background: #000; color: #fff; padding: 10px; border-radius: 6px; }
    .hidden { display: none; }
    .muted { color: #555; font-size: 13px; }
    .badge { display:inline-block; padding:4px 8px; margin:3px; background:#eee; border-radius:12px; font-size:12px; cursor:pointer; border:1px solid #ccc; color:#111; user-select:none; }
    .badge:hover { background:#ddd; }
    .badge.active { background:#e300f8; color:#fff; border-color:#000; }
    .tag-count { font-size:11px; color:#666; margin-left:6px; }
    .tagCloudWrap { margin:8px 0; }
    .metaSmall { font-size:12px;color:#444;margin-top:4px; text-align:left; }
    /* New styles for post items list */
    #postItemsList { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .post-item { padding:6px 10px; border:1px solid #ccc; border-radius:12px; background:#f3f3f3; cursor:pointer; display:inline-flex; gap:8px; align-items:center; }
    .post-item:hover { background:#e9e9e9; }
    .post-item.active { background:#000; color:#fff; border-color:#000; }
    .post-item .title { max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .post-item .btn-small { background:transparent; color:inherit; border:none; cursor:pointer; padding:2px 6px; font-size:12px; }
    .post-add { display:inline-flex; gap:8px; align-items:center; }
    .inline-input { padding:6px; border:1px solid #000; border-radius:4px; }
  </style>
</head>
<body>
  <script>
    // Bootstrap: prevent early ReferenceError by providing minimal dataStore and placeholders.
    window.dataStore = window.dataStore || { profile: {}, profileSnapshots: {}, posts: {} };
    (function(){
      const placeholderNames = [
        'renderPostVariantsForDate','getVariantsForDate','parseTagsFromString','buildProfileURL','buildProfileText',
        'renderProfileInputs','renderUsernameAreas','renderTagCloud','renderTableFiltered','renderTableFilteredSorted',
        'generateMonthOptions','generateProfileMonthOptions','loadJson','saveData','deleteData','saveProfileSnapshot',
        'updateMonthlyReachDisplay','updateMonthlyImpressionsDisplay','editData','deleteProfileSnapshot'
      ];
      placeholderNames.forEach(n=>{
        if (typeof window[n] !== 'function') window[n] = function(){ /* placeholder */ };
      });
    })();
  </script>

  <div class="content">
    <h3>Insight Konten</h3>
    <div class="form-row">
      <label>Tanggal:</label> <input type="date" id="dateInput" onchange="handleDateChange()">
    </div>
    <!-- rewritten Post (hari ini) UI -->
    <div class="form-row" style="align-items:flex-start;">
      <label>Post (hari ini):</label>
      <div style="flex:2;">
        <div id="postItemsList" aria-live="polite"></div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <button type="button" onclick="addPostItem()">(+) Tambah Post Baru</button> 
          <input id="newPostTitle" class="inline-input" placeholder="Judul post baru (opsional)"></input>
        </div>
        <small class="muted">Buat banyak post pada tanggal yang sama — klik judul untuk memilih, edit di form lalu Simpan Data.</small>
      </div>
    </div>

    <div class="form-row">
      <label>Tautan:</label><input type="text" id="link">
    </div>
    <div class="form-row">
      <label>Reach / Akun yang Dijangkau:</label><input type="number" id="reach" value="0">
    </div>
    <div class="form-row">
      <label>Tayangan (Impressions):</label><input type="number" id="impressions" value="0">
    </div>
    <div class="form-row">
      <label>Suka:</label><input type="number" id="likes" value="0">
    </div>
    <div class="form-row">
      <label>Komentar:</label><input type="number" id="comments" value="0">
    </div>
    <div class="form-row">
      <label>Bagikan:</label><input type="number" id="shares" value="0">
    </div>
    <div class="form-row">
      <label>Tersimpan:</label><input type="number" id="saves" value="0">
    </div>
    <div class="form-row">
      <label>Kunjungan Profil:</label><input type="number" id="visit" value="0" min="0">
    </div>
    <div class="form-row">
      <label>Tag / Jenis Konten:</label><input type="text" id="contentTag" placeholder="mis. Reels, #promo, carousel">
    </div>
    <div class="form-row">
      <label>Website Clicks:</label><input type="number" id="websiteClicks" value="0" min="0">
    </div>
    <div class="form-row" style="align-items:flex-start;">
      <label>Notes:</label>
      <textarea id="contentNotes" rows="3" style="flex:2; padding:6px; border:1px solid #000; border-radius:4px;"></textarea>
    </div>
    <p id="engagementRate"><strong>Engagement Rate:</strong> 0.0%</p>
    <div style="display:flex; align-items:center; gap:12px;">
      <label style="display:inline-flex; align-items:center; gap:8px;"><input type="checkbox" id="exportOnSave"> Export JSON on save</label>
      <label style="display:inline-flex; align-items:center; gap:8px;"><input type="checkbox" id="enableAutoSave" checked> Enable autosave</label>
      <div style="font-size:12px;color:#444;margin-left:8px;">
        Last edit: <span id="lastEdited" style="font-weight:normal;">-</span>
      </div>
    </div>
    <button onclick="saveData()">Simpan Data</button>
    <button onclick="document.getElementById('jsonFile').click()">Load JSON</button>
  </div>

  <div class="content">
    <div class="collapsible" onclick="toggleTable()">▼ Daftar Postingan</div>
    <div id="postSection" style="margin:10px 0;">
      <label style="margin-right:8px;"><input type="checkbox" id="compactToggle"> Compact view (sembunyikan baris setelah batas)</label>
      <label style="margin-right:8px;">Tampilkan baris: <input type="number" id="compactLimit" value="10" min="1" style="width:60px;"></label>
      <button type="button" onclick="applyCompactSetting()">Terapkan</button>
      <small class="muted" style="margin-left:10px;">Gunakan untuk menyembunyikan data saat banyak postingan.</small>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin:6px 0;">
      <label style="margin:0;">Sort By:</label>
      <select id="sortField" style="padding:6px;border:1px solid #000;border-radius:4px;margin-left:8px;">
        <option value="date">Tanggal</option>
        <option value="reach">Reach</option>
        <option value="impressions">Tayangan</option>
        <option value="likes">Suka</option>
        <option value="comments">Komentar</option>
        <option value="shares">Bagikan</option>
        <option value="saves">Tersimpan</option>
        <option value="engagement">Engagement</option>
      </select>
      <label style="margin-left:8px;">Urut:</label>
      <select id="sortDir" style="padding:6px;border:1px solid #000;border-radius:4px;margin-left:4px;">
        <option value="none">Tidak (default)</option>
        <option value="highest">Tertinggi → Rendah</option>
        <option value="lowest">Terendah → Tinggi</option>
      </select>
      <label style="margin-left:12px;">Cari Kata Kunci:</label>
      <input type="text" id="tagFilter" placeholder="ketik kata kunci (link, notes, tag, tanggal)..." style="padding:6px;border:1px solid #000;border-radius:4px;">
      <button type="button" id="applyTableFilterBtn">Terapkan</button>
    </div>

    <div id="postListBox"></div>
    <label for="monthFilter"><strong>Filter Bulan:</strong></label>
    <select id="monthFilter" onchange="renderTableFiltered()">
      <option value="all">Semua</option>
    </select>

    <div class="tagCloudWrap">
      <strong>Tag Cloud:</strong>
      <div id="tagCloud" style="display:inline-block; margin-left:8px;"></div>
    </div>

    <button onclick="exportCsvPosts()">Export CSV Postingan</button>
    <button onclick="exportCsvPostsFiltered()">Export CSV (Sesuai Filter)</button>
    <button type="button" onclick="resetTagCloud()">Reset Tag Cloud</button>

    <table id="dataTable">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Tautan</th>
          <th>Reach</th>
          <th>Tayangan</th>
          <th>Suka</th>
          <th>Komentar</th>
          <th>Bagikan</th>
          <th>Tersimpan</th>
          <th>Tingkat Interaksi %</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="content">
    <h3>Profile Insight</h3>
    <div class="form-row">
      <label>Username / IG Profile:</label><input type="text" id="username" placeholder="contoh: amk.office">
    </div>
    <p class="muted">Pratinjau: <span id="usernamePreview">(belum diisi)</span></p>
    <div style="margin-top:12px; border-top:1px dashed #ccc; padding-top:10px;"></div>
    <div class="form-row">
      <label>Periode (Bulan):</label><input type="month" id="profileMonthInput">
    </div>
    <div class="form-row">
      <label>Filter Berdasarkan Bulan:</label>
      <select id="profileMonthFilter" onchange="loadProfileSnapshot()">
        <option value="all">Semua</option>
      </select>
    </div>
    <button onclick="saveProfileSnapshot()">Simpan Snapshot Bulanan</button>
    <button onclick="deleteProfileSnapshot()">Hapus Snapshot Terpilih</button>
    <button onclick="exportCsvProfile()">Export CSV Snapshot</button>

    <div class="form-row">
      <label>Followers Awal Bulan:</label><input type="number" id="followersStart" value="0">
    </div>
    <div class="form-row">
      <label>Followers Hari ini:</label><input type="number" id="followersEnd" value="0">
    </div>

    <h4>Age Range (%)</h4>
    <div class="form-row"><label>18-24:</label><input type="number" id="age18_24" value="0"></div>
    <div class="form-row"><label>25-34:</label><input type="number" id="age25_34" value="0"></div>
    <div class="form-row"><label>35-44:</label><input type="number" id="age35_44" value="0"></div>
    <div class="form-row"><label>45-54:</label><input type="number" id="age45_54" value="0"></div>
    <div class="form-row"><label>55-64:</label><input type="number" id="age55_64" value="0"></div>

    <h4>Gender (%)</h4>
    <div class="form-row"><label>Male:</label><input type="number" id="male" value="0"></div>
    <div class="form-row"><label>Female:</label><input type="number" id="female" value="0"></div>

    <p><strong>Total Reach Bulanan (Akun yang dijangkau):</strong> <span id="monthlyReachTotal">0</span></p>
    <p><strong>Total Tayangan Bulanan (Impressions):</strong> <span id="monthlyImpressionsTotal">0</span></p>
  </div>

  <button onclick="updateProfile()">Calculate Insights</button>
  <input type="file" id="jsonFile" accept=".json" style="display:none" onchange="loadJson(event)">
  <button onclick="exportJson()">Ekspor JSON</button>
  <button onclick="document.getElementById('jsonFile').click()">Load JSON</button>

  <ul>
    <li>IG Profile: <span id="igProfileLink">(belum diisi)</span></li>
    <li>Follower Growth: <span id="followerGrowth">0</span></li>
    <li>Growth Rate: <span id="growthRate">0.0%</span></li>
    <li>Average Reach Rate: <span id="reachRate">0.0%</span></li>
    <li>Average Engagement Rate: <span id="avgEngagement">0.0%</span></li>
  </ul>

  <canvas id="profileChart"></canvas>
  <div style="display:flex; justify-content:center; align-items:center; margin:14px 0;"></div>
  <span style="font-size:11px;color:rgba(0, 0, 0, 0.726);font-weight:normal;opacity:0.6;user-select:none;pointer-events:none;">Created by Arghi</span>

  <script>
    (function(){
      // default store
      window.dataStore = window.dataStore || {
        profile: { username:"", followersStart:0, followersEnd:0, ageRange:{"18-24":0,"25-34":0,"35-44":0,"45-54":0,"55-64":0}, gender:{male:0,female:0} },
        profileSnapshots: {},
        posts: {}
      };

      // helpers
      function normalizeUsername(raw){ return raw ? String(raw).trim().replace(/^@+/, "") : ""; }
      function buildProfileURL(u){ return u ? "https://instagram.com/" + normalizeUsername(u) : ""; }
      function buildProfileText(u){ return u ? "@" + normalizeUsername(u) : ""; }
      function parseTagsFromString(s){
        if (!s) return [];
        return String(s).split(/[,;]+|\s+/).map(t=>t.replace(/^#+/,'').trim().toLowerCase()).filter(Boolean);
      }
      window.parseTagsFromString = parseTagsFromString;

      // normalize posts structure to use _items []
      function normalizePostsStructure(){
        const out = {};
        Object.keys(window.dataStore.posts || {}).forEach(date => {
          const p = window.dataStore.posts[date] || {};
          // if already normalized
          if (Array.isArray(p._items)) {
            // ensure numeric normalization and tags array
            p._items = p._items.map(v => normalizeItem(v));
            out[date] = p;
            return;
          }
          // legacy: main object + optional _variants array -> convert
          const items = [];
          const main = Object.assign({}, p);
          // remove _variants if present on main
          const variants = Array.isArray(main._variants) ? main._variants : (Array.isArray(p._variants) ? p._variants : []);
          if (main._variants) delete main._variants;
          // main may contain title/link etc; if it has only _variants and no fields, main item may be empty -> still push
          items.push(normalizeItem(main));
          (variants || []).forEach(v => { items.push(normalizeItem(v)); });
          out[date] = { _items: items };
        });
        window.dataStore.posts = out;
      }

      function normalizeItem(v){
        v = Object.assign({}, v || {});
        v.reach = +v.reach || 0;
        v.impressions = +v.impressions || 0;
        v.likes = +v.likes || 0;
        v.comments = +v.comments || 0;
        v.shares = +v.shares || 0;
        v.saves = +v.saves || 0;
        v.visit = +v.visit || 0;
        v.websiteClicks = +v.websiteClicks || 0;
        v.engagement = v.engagement !== undefined ? +v.engagement : (v.reach>0?(((v.likes||0)+(v.comments||0)+(v.shares||0)+(v.saves||0))/ (v.reach||1) *100):0);
        if (!Array.isArray(v.tags)) v.tags = v.tag ? parseTagsFromString(v.tag) : (v.tags || []);
        v.title = v.title || "";
        v.notes = v.notes || "";
        v.lastEdited = v.lastEdited || v._lastEdited || null;
        return v;
      }

      // ensure initial normalization
      normalizePostsStructure();

      // items API (compatibility with previous getVariantsForDate)
      function getVariantsForDate(date){
        // returns array of { title, data, isMain } compatible with previous API
        const base = window.dataStore.posts[date] || { _items: [] };
        const arr = Array.isArray(base._items) ? base._items : [];
        return arr.map((it, i) => ({ title: it.title || `Post ${i+1}`, data: it, isMain: i===0 }));
      }
      window.getVariantsForDate = getVariantsForDate;

      // Post items list UI
      window.currentPostIndex = 0;
      function renderPostVariantsForDate(date){
        // compatibility wrapper -> call new renderer
        renderPostItemsForDate(date);
      }
      window.renderPostVariantsForDate = renderPostVariantsForDate;

      function renderPostItemsForDate(date){
        const container = document.getElementById('postItemsList');
        if (!container) return;
        container.innerHTML = '';
        if (!date) { container.innerHTML = '<span class="muted">(Pilih tanggal untuk melihat post)</span>'; return; }
        const obj = window.dataStore.posts[date] || { _items: [] };
        if (!Array.isArray(obj._items)) obj._items = [];
        // render each item
        obj._items.forEach((item, idx) => {
          const span = document.createElement('button');
          span.className = 'post-item' + (idx === window.currentPostIndex ? ' active' : '');
          span.setAttribute('data-idx', idx);
          span.title = item.title || `Post ${idx+1}`;
          span.innerHTML = `<span style="font-size:11px;color:rgba(0,0,0,0.6);">#${idx+1}</span><span class="title">${escapeHtml(item.title || ('Post ' + (idx+1)))}</span>`;
          span.addEventListener('click', function(e){
            const i = parseInt(this.getAttribute('data-idx'),10);
            selectPostIndex(i);
          });
          // small delete button
          const delBtn = document.createElement('button');
          delBtn.className = 'btn-small';
          delBtn.innerHTML = '✕';
          delBtn.title = 'Hapus post ini';
          delBtn.addEventListener('click', function(ev){
            ev.stopPropagation();
            if (!confirm('Hapus post #' + (idx+1) + ' pada ' + date + ' ?')) return;
            deletePostItem(date, idx);
          });
          span.appendChild(delBtn);
          container.appendChild(span);
        });
        // if no items show placeholder
        if (!obj._items.length) container.innerHTML = '<span class="muted">(Belum ada post pada tanggal ini)</span>';
        // update newPostTitle placeholder
        document.getElementById('newPostTitle').value = '';
        // ensure current index valid
        if (window.currentPostIndex >= (obj._items.length || 0)) window.currentPostIndex = Math.max(0, (obj._items.length||0)-1);
        // apply active class after rendering
        Array.from(container.querySelectorAll('.post-item')).forEach(el => el.classList.toggle('active', parseInt(el.getAttribute('data-idx'),10) === window.currentPostIndex));
      }

      function selectPostIndex(idx){
        const date = document.getElementById('dateInput')?.value;
        if (!date) return alert('Pilih tanggal terlebih dahulu.');
        const obj = window.dataStore.posts[date] || { _items: [] };
        if (!Array.isArray(obj._items)) obj._items = [];
        if (idx < 0 || idx >= obj._items.length) return;
        window.currentPostIndex = idx;
        renderPostItemsForDate(date);
        populateFormFromSelected(date, idx);
      }

      function populateFormFromSelected(date, idx){
        const obj = window.dataStore.posts[date] || { _items: [] };
        const v = obj._items[idx] || {};
        document.getElementById("link").value = v.link || "";
        document.getElementById("reach").value = v.reach || 0;
        document.getElementById("impressions").value = v.impressions || 0;
        document.getElementById("likes").value = v.likes || 0;
        document.getElementById("comments").value = v.comments || 0;
        document.getElementById("shares").value = v.shares || 0;
        document.getElementById("saves").value = v.saves || 0;
        document.getElementById("contentTag").value = (v.tags && v.tags.length) ? v.tags.join(', ') : (v.tag || '');
        document.getElementById("contentNotes").value = v.notes || "";
        document.getElementById("websiteClicks").value = v.websiteClicks || 0;
        document.getElementById("visit").value = v.visit || 0;
        // set newPostTitle to item title when selecting to ease rename
        document.getElementById("newPostTitle").value = v.title || "";
        updateLastEditedDisplay(v.lastEdited || null);
        updateEngagement();
      }

      function addPostItem(){
        const date = document.getElementById("dateInput")?.value;
        if (!date) { alert("Silakan pilih tanggal terlebih dahulu."); return; }
        if (!window.dataStore.posts[date]) window.dataStore.posts[date] = { _items: [] };
        if (!Array.isArray(window.dataStore.posts[date]._items)) window.dataStore.posts[date]._items = [];
        let rawTitle = (document.getElementById("newPostTitle")?.value || "").trim();
        // fallback to "Post N"
        if (!rawTitle) rawTitle = 'Post ' + (window.dataStore.posts[date]._items.length + 1);
        // ensure unique title among items for this date
        const existing = window.dataStore.posts[date]._items.map(it => (it.title||'').trim().toLowerCase());
        let uniqueTitle = rawTitle;
        let counter = 2;
        while (existing.includes(uniqueTitle.toLowerCase())) {
          uniqueTitle = rawTitle + " (" + counter + ")";
          counter++;
        }
        const newItem = normalizeItem({
          title: uniqueTitle,
          link: "",
          reach: 0,
          impressions: 0,
          likes: 0,
          comments: 0,
          shares: 0,
          saves: 0,
          visit: 0,
          tag: "",
          tags: [],
          notes: "",
          websiteClicks: 0,
          lastEdited: new Date().toISOString()
        });
        window.dataStore.posts[date]._items.push(newItem);
        window.currentPostIndex = window.dataStore.posts[date]._items.length - 1;
        renderPostItemsForDate(date);
        populateFormFromSelected(date, window.currentPostIndex);
        showSaveNotification("Post baru dibuat untuk " + date + " — " + uniqueTitle);
      }
      window.addPostItem = addPostItem;

      function deletePostItem(date, idx){
        if (!date || !window.dataStore.posts[date]) return;
        const arr = window.dataStore.posts[date]._items || [];
        if (!Array.isArray(arr) || idx < 0 || idx >= arr.length) return;
        arr.splice(idx,1);
        if (!arr.length) delete window.dataStore.posts[date];
        else window.dataStore.posts[date]._items = arr;
        // adjust currentPostIndex
        window.currentPostIndex = Math.max(0, Math.min(window.currentPostIndex, (window.dataStore.posts[date]?._items?.length || 0) - 1));
        generateMonthOptions();
        renderTableFiltered();
        renderTagCloud();
        renderPostItemsForDate(date);
      }

      // tag cloud & selection
      window.selectedTags = window.selectedTags || new Set();

      function renderTagCloud(){
        const cloud = document.getElementById('tagCloud');
        if (!cloud) return;
        const counts = {};
        Object.keys(dataStore.posts || {}).forEach(k => {
          const p = dataStore.posts[k] || {};
          const items = Array.isArray(p._items) ? p._items : [];
          items.forEach(item => {
            const coll = Array.isArray(item.tags) ? item.tags : (item.tag ? parseTagsFromString(item.tag) : []);
            coll.forEach(t => counts[t] = (counts[t]||0) + 1);
          });
        });
        cloud.innerHTML = "";
        const keys = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
        if (!keys.length) { cloud.innerHTML = '<span class="muted">(Belum ada tag)</span>'; return; }
        keys.forEach(t => {
          const sp = document.createElement('span');
          sp.className = 'badge' + (window.selectedTags.has(t) ? ' active' : '');
          sp.setAttribute('data-tag', t);
          sp.innerHTML = '#' + t + '<span class="tag-count">(' + counts[t] + ')</span>';
          sp.addEventListener('click', function(){
            if (window.selectedTags.has(t)) window.selectedTags.delete(t);
            else window.selectedTags.add(t);
            // sync input
            const tf = document.getElementById('tagFilter');
            if (tf) tf.value = Array.from(window.selectedTags).join(' ');
            // rerender table & cloud
            renderTableFilteredSorted();
            renderTagCloud();
          });
          cloud.appendChild(sp);
        });
      }
      window.renderTagCloud = renderTagCloud;

      function selectTagFromTable(tag){
        // when clicking a tag inside table, set it as single selected tag and update UI
        window.selectedTags = new Set([tag]);
        const tf = document.getElementById('tagFilter');
        if (tf) tf.value = tag;
        renderTableFilteredSorted();
        renderTagCloud();
      }

      // months dropdowns
      function generateMonthOptions(){
        const select = document.getElementById("monthFilter");
        if (!select) return;
        const prev = select.value || "all";
        select.innerHTML = '<option value="all">Semua</option>';
        const set = new Set();
        Object.keys(dataStore.posts || {}).forEach(d => { if (d && d.length>=7) set.add(d.slice(0,7)); });
        Array.from(set).sort().forEach(m => {
          const opt = document.createElement('option'); opt.value = m; opt.textContent = m; select.appendChild(opt);
        });
        if ([...select.options].some(o=>o.value===prev)) select.value = prev;
        // also update profileMonthForReach if exists
        const select2 = document.getElementById("profileMonthForReach");
        if (select2) {
          const prev2 = select2.value || "all";
          select2.innerHTML = '<option value="all">Semua</option>';
          Array.from(set).sort().forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; select2.appendChild(opt); });
          if ([...select2.options].some(o=>o.value===prev2)) select2.value = prev2;
        }
      }
      window.generateMonthOptions = generateMonthOptions;

      function generateProfileMonthOptions(){
        const select = document.getElementById("profileMonthFilter");
        if (!select) return;
        const prev = select.value || "all";
        select.innerHTML = '<option value="all">Semua</option>';
        const set = new Set();
        Object.keys(dataStore.posts || {}).forEach(d => { if (d && d.length>=7) set.add(d.slice(0,7)); });
        Object.keys(dataStore.profileSnapshots || {}).forEach(m => set.add(m));
        Array.from(set).sort().forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; select.appendChild(opt); });
        if ([...select.options].some(o=>o.value===prev)) select.value = prev;
      }
      window.generateProfileMonthOptions = generateProfileMonthOptions;

      // monthly totals
      function calculateMonthlyReach(month){
        let total = 0;
        Object.keys(dataStore.posts || {}).forEach(d => { if (!d) return; if (month && month!=="all" && !d.startsWith(month)) return; const p = dataStore.posts[d] || {}; const items = Array.isArray(p._items) ? p._items : []; items.forEach(it => { total += +(it.reach || 0); }); });
        return total;
      }
      function calculateMonthlyImpressions(month){
        let total = 0;
        Object.keys(dataStore.posts || {}).forEach(d => { if (!d) return; if (month && month!=="all" && !d.startsWith(month)) return; const p = dataStore.posts[d] || {}; const items = Array.isArray(p._items) ? p._items : []; items.forEach(it => { total += +(it.impressions || 0); }); });
        return total;
      }
      function updateMonthlyReachDisplay(){
        const sel = document.getElementById("profileMonthForReach") || document.getElementById("profileMonthFilter");
        const month = sel ? sel.value : "all";
        const el = document.getElementById("monthlyReachTotal");
        if (el) el.innerText = calculateMonthlyReach(month);
      }
      function updateMonthlyImpressionsDisplay(){
        const sel = document.getElementById("profileMonthForReach") || document.getElementById("profileMonthFilter");
        const month = sel ? sel.value : "all";
        const el = document.getElementById("monthlyImpressionsTotal");
        if (el) el.innerText = calculateMonthlyImpressions(month);
      }

      // profile inputs
      function renderProfileInputs(){
        const p = dataStore.profile || {};
        const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = (v === undefined || v === null) ? 0 : v; };
        if (document.getElementById("username")) document.getElementById("username").value = p.username || "";
        setVal("followersStart", p.followersStart || 0);
        setVal("followersEnd", p.followersEnd || 0);
        setVal("age18_24", p.ageRange?.["18-24"] || 0);
        setVal("age25_34", p.ageRange?.["25-34"] || 0);
        setVal("age35_44", p.ageRange?.["35-44"] || 0);
        setVal("age45_54", p.ageRange?.["45-54"] || 0);
        setVal("age55_64", p.ageRange?.["55-64"] || 0);
        setVal("male", p.gender?.male || 0);
        setVal("female", p.gender?.female || 0);
        renderUsernameAreas();
      }

      function renderUsernamePreview(){
        const u = document.getElementById("username") ? document.getElementById("username").value : "";
        const preview = document.getElementById("usernamePreview");
        if (preview) preview.textContent = buildProfileText(u) || "(belum diisi)";
      }

      function renderUsernameAreas(){
        const p = dataStore.profile || {};
        const uname = p.username || (document.getElementById('username')?.value || "");
        const linkSpan = document.getElementById('igProfileLink');
        if (!linkSpan) return;
        if (uname) {
          const url = buildProfileURL(uname);
          const text = buildProfileText(uname);
          linkSpan.innerHTML = `<a href="${url}" target="_blank">${text}</a>`;
        } else linkSpan.textContent = "(belum diisi)";
        renderUsernamePreview();
      }

      function updateProfile(){
        dataStore.profile.username = normalizeUsername(document.getElementById("username")?.value || "");
        dataStore.profile.followersStart = +document.getElementById("followersStart")?.value || 0;
        dataStore.profile.followersEnd = +document.getElementById("followersEnd")?.value || 0;
        dataStore.profile.ageRange["18-24"] = +document.getElementById("age18_24")?.value || 0;
        dataStore.profile.ageRange["25-34"] = +document.getElementById("age25_34")?.value || 0;
        dataStore.profile.ageRange["35-44"] = +document.getElementById("age35_44")?.value || 0;
        dataStore.profile.ageRange["45-54"] = +document.getElementById("age45_54")?.value || 0;
        dataStore.profile.ageRange["55-64"] = +document.getElementById("age55_64")?.value || 0;
        dataStore.profile.gender.male = +document.getElementById("male")?.value || 0;
        dataStore.profile.gender.female = +document.getElementById("female")?.value || 0;

        const start = dataStore.profile.followersStart || 0;
        const end = dataStore.profile.followersEnd || 0;
        const growth = end - start;
        const growthRate = start > 0 ? (growth / start) * 100 : 0;

        let totalReach = 0, totalImpr = 0, totalEng = 0, count = 0;
        Object.keys(dataStore.posts || {}).forEach(k => {
          const p = dataStore.posts[k] || {};
          const items = Array.isArray(p._items) ? p._items : [];
          items.forEach(d => {
            totalReach += d.reach || 0;
            totalImpr += d.impressions || 0;
            const er = (d && d.engagement !== undefined) ? +d.engagement : (d.reach>0 ? (((d.likes||0)+(d.comments||0)+(d.shares||0)+(d.saves||0))/(d.reach||1)*100) : 0);
            totalEng += er; count++;
          });
        });
        const avgReachRate = end > 0 ? (totalReach / end) * 100 : 0;
        const avgEngagement = count > 0 ? (totalEng / count) : 0;

        const setText = (id, v) => { const el = document.getElementById(id); if (el) el.innerText = v; };
        setText("followerGrowth", growth);
        setText("growthRate", growthRate.toFixed(1) + "%");
        setText("reachRate", avgReachRate.toFixed(1) + "%");
        setText("avgEngagement", avgEngagement.toFixed(1) + "%");

        const canvas = document.getElementById("profileChart");
        if (canvas) {
          const ctx = canvas.getContext("2d");
          const labels = ["Follower Growth","Growth Rate %","Avg Reach Rate %","Avg Engagement %"];
          const values = [growth, Number(growthRate.toFixed(1)), Number(avgReachRate.toFixed(1)), Number(avgEngagement.toFixed(1))];
          if (window._profileChart) window._profileChart.destroy();
          window._profileChart = new Chart(ctx, { type:"bar", data:{ labels, datasets:[{ label:"Profile Metrics", data: values, backgroundColor:["#4e79a7","#f28e2b","#e15759","#76b7b2"] }] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } } });
        }

        updateMonthlyReachDisplay();
        updateMonthlyImpressionsDisplay();
        renderUsernameAreas();
      }

      // engagement calculator
      function updateEngagement(){
        const reach = +document.getElementById("reach")?.value || 0;
        const likes = +document.getElementById("likes")?.value || 0;
        const comments = +document.getElementById("comments")?.value || 0;
        const shares = +document.getElementById("shares")?.value || 0;
        const saves = +document.getElementById("saves")?.value || 0;
        const er = reach > 0 ? ((likes+comments+shares+saves)/reach)*100 : 0;
        const el = document.getElementById("engagementRate");
        if (el) el.innerHTML = "<strong>Engagement Rate:</strong> " + er.toFixed(1) + "%";
      }

      let autosaveTimer = null;
      function scheduleAutoSave(ms){
        try { clearTimeout(autosaveTimer); } catch(e){}
        // only schedule if autosave enabled in UI
        const enabled = document.getElementById('enableAutoSave')?.checked;
        if (!enabled) return;
        autosaveTimer = setTimeout(function(){ if (typeof saveData === 'function') saveData(); }, ms || 1200);
      }

      function updateLastEditedDisplay(iso){
        const el = document.getElementById("lastEdited");
        if (!el) return;
        if (!iso) { el.textContent = "-"; return; }
        try { el.textContent = new Date(iso).toLocaleString(); } catch(e) { el.textContent = iso; }
      }

      // save data (now saves into selected item on selected date)
      function saveData(){
        const date = document.getElementById("dateInput")?.value;
        if (!date) { alert("Silakan pilih tanggal terlebih dahulu."); return; }
        if (!window.dataStore.posts[date]) window.dataStore.posts[date] = { _items: [] };
        if (!Array.isArray(window.dataStore.posts[date]._items)) window.dataStore.posts[date]._items = [];

        const link = document.getElementById("link")?.value || "";
        const reach = +document.getElementById("reach")?.value || 0;
        const impressions = +document.getElementById("impressions")?.value || 0;
        const likes = +document.getElementById("likes")?.value || 0;
        const comments = +document.getElementById("comments")?.value || 0;
        const shares = +document.getElementById("shares")?.value || 0;
        const saves = +document.getElementById("saves")?.value || 0;
        const visit = +document.getElementById("visit")?.value || 0;
        const engagement = reach > 0 ? ((likes+comments+shares+saves)/reach)*100 : 0;
        const rawTag = document.getElementById("contentTag")?.value || "";
        const tags = parseTagsFromString(rawTag);
        const idx = window.currentPostIndex || 0;
        // ensure item exists
        if (!window.dataStore.posts[date]._items[idx]) {
          // create placeholder items up to idx
          while (window.dataStore.posts[date]._items.length <= idx) {
            window.dataStore.posts[date]._items.push(normalizeItem({title: 'Post ' + (window.dataStore.posts[date]._items.length+1)}));
          }
        }
        const titleVal = (document.getElementById("newPostTitle")?.value || "").trim();
        const item = Object.assign({}, window.dataStore.posts[date]._items[idx]);
        Object.assign(item, { link, reach, impressions, likes, comments, shares, saves, visit, engagement, tag: rawTag, tags, notes: document.getElementById("contentNotes")?.value || "", websiteClicks: +document.getElementById("websiteClicks")?.value || 0, lastEdited: new Date().toISOString() });
        if (titleVal) item.title = titleVal;
        window.dataStore.posts[date]._items[idx] = normalizeItem(item);

        // update profile basic snapshot fields
        dataStore.profile = {
          username: normalizeUsername(document.getElementById("username")?.value || ""),
          followersStart: +document.getElementById("followersStart")?.value || 0,
          followersEnd: +document.getElementById("followersEnd")?.value || 0,
          ageRange: {
            "18-24": +document.getElementById("age18_24")?.value || 0,
            "25-34": +document.getElementById("age25_34")?.value || 0,
            "35-44": +document.getElementById("age35_44")?.value || 0,
            "45-54": +document.getElementById("age45_54")?.value || 0,
            "55-64": +document.getElementById("age55_64")?.value || 0
          },
          gender: { male: +document.getElementById("male")?.value || 0, female: +document.getElementById("female")?.value || 0 }
        };

        normalizePostsStructure();
        generateMonthOptions();
        generateProfileMonthOptions();
        renderTableFiltered();
        renderUsernameAreas();
        renderProfileInputs();
        updateMonthlyReachDisplay();
        updateMonthlyImpressionsDisplay();
        renderTagCloud();
        updateLastEditedDisplay(new Date().toISOString());

        // export option
        if (document.getElementById('exportOnSave')?.checked) exportJson();
        showSaveNotification("Data tersimpan untuk " + date);
        // re-render items list and keep selection
        renderPostItemsForDate(date);
      }
      window.saveData = saveData;

      // handle date change
      function handleDateChange(){
        const date = document.getElementById("dateInput")?.value;
        if (!date) return;
        // ensure structure exists
        if (!window.dataStore.posts[date]) window.dataStore.posts[date] = { _items: [] };
        if (!Array.isArray(window.dataStore.posts[date]._items)) window.dataStore.posts[date]._items = [];
        // render items & select first if none selected
        if (window.dataStore.posts[date]._items.length === 0) window.currentPostIndex = 0;
        else window.currentPostIndex = Math.min(window.currentPostIndex || 0, window.dataStore.posts[date]._items.length - 1);
        renderPostItemsForDate(date);
        populateFormFromSelected(date, window.currentPostIndex);
        updateEngagement();
      }
      window.handleDateChange = handleDateChange;

      // table rendering & helpers
      function escapeHtml(str){
        return String(str || "").replace(/[&<>"']/g, function(m){
          return ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" })[m];
        });
      }

      function renderTableFiltered(){
        return renderTableFilteredSorted();
      }
      window.renderTableFiltered = renderTableFiltered;

      function renderTableFilteredSorted(){
        const selectedMonth = document.getElementById("monthFilter")?.value || "all";
        const tbody = document.querySelector("#dataTable tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        const entries = [];
        const dates = Object.keys(dataStore.posts || {});
        dates.forEach(date => {
          const p = dataStore.posts[date] || {};
          const items = Array.isArray(p._items) ? p._items : [];
          items.forEach((v, i) => entries.push({ date, idx: i, data: v, token: `${date}||${i}` }));
        });

        // filter month
        let filtered = entries.filter(e => {
          if (selectedMonth !== "all" && !e.date.startsWith(selectedMonth)) return false;
          return true;
        });

        // selectedTags filter: if selectedTags set, only include entries that contain at least one selected tag
        const selectedKwSet = new Set((document.getElementById('tagFilter')?.value || '').toLowerCase().split(/\s+/).filter(Boolean));
        if (window.selectedTags && window.selectedTags.size) {
          // if user used tag cloud to select tags, ensure keyword sync
          Array.from(window.selectedTags).forEach(t => selectedKwSet.add(t));
        }

        if (selectedKwSet.size) {
          filtered = filtered.filter(e => {
            const txtFields = ((e.data.title||"") + " " + (e.data.link||"") + " " + (e.data.notes||"") + " " + ((Array.isArray(e.data.tags) ? e.data.tags.join(' ') : (e.data.tag||""))) + " " + e.date).toLowerCase();
            // must contain all words in selectedKwSet (improves responsiveness)
            for (const w of selectedKwSet) {
              if (!txtFields.includes(w)) return false;
            }
            return true;
          });
        }

        // sorting
        const sortField = document.getElementById('sortField')?.value || 'date';
        const sortDir = document.getElementById('sortDir')?.value || 'none';
        if (sortDir && sortDir !== 'none') {
          filtered.sort((a,b) => {
            let va, vb;
            if (sortField === 'date') { va = a.date; vb = b.date; }
            else if (sortField === 'engagement') {
              const calc = d => (d && d.engagement !== undefined) ? +d.engagement : ((d && d.reach) ? (((d.likes||0)+(d.comments||0)+(d.shares||0)+(d.saves||0)) / (d.reach||1) * 100) : 0);
              va = calc(a.data); vb = calc(b.data);
            } else {
              va = +(a.data?.[sortField] || 0);
              vb = +(b.data?.[sortField] || 0);
            }
            if (sortDir === 'highest') return vb - va;
            if (sortDir === 'lowest') return va - vb;
            return 0;
          });
        } else {
          filtered.sort((a,b) => b.date.localeCompare(a.date));
        }

        // render rows
        filtered.forEach(entry => {
          const date = entry.date;
          const d = entry.data || {};
          const rate = (d && d.engagement !== undefined) ? d.engagement : (d.reach>0 ? (((d.likes||0)+(d.comments||0)+(d.shares||0)+(d.saves||0))/(d.reach||1)*100) : 0);
          const tags = Array.isArray(d.tags) ? d.tags : (d.tag ? parseTagsFromString(d.tag) : []);
          const tagHtml = tags.map(t => `<span class="badge" onclick="selectTagFromTable('${escapeHtml(t)}')">#${escapeHtml(t)}</span>`).join(' ');
          const linkHtml = d.link ? `<a href="${escapeHtml(d.link)}" target="_blank">${escapeHtml(d.link)}</a>` : "";
          const titleHtml = d.title ? `<div class="metaSmall">(${escapeHtml(d.title)})</div>` : "";
          const notesHtml = d.notes ? `<div class="metaSmall">Notes: ${escapeHtml(d.notes)}</div>` : "";
          const meta = (tagHtml || titleHtml || notesHtml) ? `<div style="margin-top:6px; text-align:left;">${tagHtml}${titleHtml}${notesHtml}</div>` : "";
          const row = `<tr>
            <td>${escapeHtml(date)}</td>
            <td style="text-align:left;">${linkHtml}${meta}</td>
            <td>${d.reach||0}</td><td>${d.impressions||0}</td><td>${d.likes||0}</td><td>${d.comments||0}</td>
            <td>${d.shares||0}</td><td>${d.saves||0}</td>
            <td>${Number(rate).toFixed(1)}%</td>
            <td><button onclick="editData('${entry.token}')">Ubah</button> <button onclick="deleteData('${entry.token}')">Hapus</button></td>
          </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);
        });

        try { applyCompactSetting(); } catch(e){}
        renderTagCloud();
        // update visuals of tag cloud to reflect current tagFilter tokens
        syncSelectedTagsFromFilter();
      }
      window.renderTableFilteredSorted = renderTableFilteredSorted;

      function syncSelectedTagsFromFilter(){
        const tfVal = (document.getElementById('tagFilter')?.value || '').trim().toLowerCase();
        if (!tfVal) {
          window.selectedTags = new Set();
        } else {
          // parse words and set as selected tags set
          const arr = tfVal.split(/\s+/).filter(Boolean);
          window.selectedTags = new Set(arr);
        }
        // update cloud visuals
        document.querySelectorAll('#tagCloud .badge').forEach(b=> {
          const t = b.getAttribute('data-tag');
          b.classList.toggle('active', window.selectedTags.has(t));
        });
      }

      // compact settings
      function applyCompactSetting(){
        const compact = document.getElementById('compactToggle')?.checked;
        const limitRaw = document.getElementById('compactLimit')?.value;
        const limit = Math.max(1, parseInt(limitRaw||'10',10) || 10);
        const tbody = document.querySelector('#dataTable tbody');
        if (!tbody) return;
        Array.from(tbody.querySelectorAll('tr')).forEach((r,i) => r.style.display = (compact && i>=limit) ? 'none' : '');
      }
      function initCompactObserver(){
        const tbody = document.querySelector('#dataTable tbody');
        if (!tbody) return;
        applyCompactSetting();
        const obs = new MutationObserver(()=>applyCompactSetting());
        obs.observe(tbody, { childList: true });
        document.getElementById('compactToggle')?.addEventListener('change', applyCompactSetting);
        document.getElementById('compactLimit')?.addEventListener('input', applyCompactSetting);
      }

      function toggleTable(){
        const el = document.getElementById('postSection');
        if (!el) return;
        el.style.display = (el.style.display === 'none') ? '' : 'none';
      }
      window.toggleTable = toggleTable;

      function resetTagCloud(){
        const tf = document.getElementById('tagFilter');
        if (tf) tf.value = '';
        window.selectedTags = new Set();
        document.querySelectorAll('#tagCloud .badge').forEach(b=>b.classList.remove('active'));
        renderTableFiltered();
        renderTagCloud();
      }
      window.resetTagCloud = resetTagCloud;

      // edit/delete functions (tokens are date||idx)
      function editData(token){
        const parts = String(token||'').split('||');
        const date = parts[0];
        const idx = parts.length>1 ? parseInt(parts[1],10) : 0;
        if (!date || !dataStore.posts[date]) return alert("Data tidak ditemukan untuk " + token);
        document.getElementById("dateInput").value = date;
        renderPostItemsForDate(date);
        const sel = document.getElementById("postItemsList");
        if (sel) {
          window.currentPostIndex = idx;
          renderPostItemsForDate(date);
        }
        populateFormFromSelected(date, idx);
        alert("Data dimuat untuk diedit: " + token);
      }
      window.editData = editData;

      function deleteData(token){
        const parts = String(token||'').split('||');
        const date = parts[0];
        const idx = parts.length>1 ? parseInt(parts[1],10) : 0;
        if (!date || !dataStore.posts[date]) return alert("Data tidak ditemukan untuk " + token);
        if (!confirm("Hapus data untuk " + token + "?")) return;
        if (Array.isArray(dataStore.posts[date]._items) && dataStore.posts[date]._items[idx]) {
          dataStore.posts[date]._items.splice(idx,1);
          if (!dataStore.posts[date]._items.length) delete dataStore.posts[date];
        }
        generateMonthOptions();
        renderTableFiltered();
        updateMonthlyReachDisplay();
        updateMonthlyImpressionsDisplay();
        renderTagCloud();
        // Update post items list if current date matches
        if (document.getElementById('dateInput')?.value === date) renderPostItemsForDate(date);
      }
      window.deleteData = deleteData;

      // export/import
      function exportJson(){
        // export current dataStore as-is (uses _items structure)
        const blob = new Blob([JSON.stringify(dataStore, null, 2)], { type: "application/json" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "insight_data.json"; a.click();
      }
      window.exportJson = exportJson;

      function loadJson(event){
        const file = event?.target?.files && event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e){
          try {
            const parsed = JSON.parse(e.target.result);
            if (parsed.profile) dataStore.profile = Object.assign({}, dataStore.profile || {}, parsed.profile);
            if (parsed.profileSnapshots) dataStore.profileSnapshots = Object.assign({}, dataStore.profileSnapshots || {}, parsed.profileSnapshots);
            if (parsed.posts) {
              // merge posts, normalize numbers, accept both legacy and new formats
              Object.keys(parsed.posts).forEach(d => {
                const p = parsed.posts[d] || {};
                // If parsed has _items already use them
                if (Array.isArray(p._items)) {
                  p._items = p._items.map(v => normalizeItem(v));
                  dataStore.posts[d] = { _items: p._items };
                } else {
                  // legacy: main object + optional _variants
                  const items = [];
                  const main = Object.assign({}, p);
                  const variants = Array.isArray(main._variants) ? main._variants : [];
                  if (main._variants) delete main._variants;
                  items.push(normalizeItem(main));
                  (variants || []).forEach(v => items.push(normalizeItem(v)));
                  dataStore.posts[d] = { _items: items };
                }
              });
            }
            // normalize fully to ensure new structure
            normalizePostsStructure();
            generateMonthOptions();
            generateProfileMonthOptions();
            renderTableFiltered();
            renderProfileInputs();
            renderUsernameAreas();
            updateMonthlyReachDisplay();
            updateMonthlyImpressionsDisplay();
            renderTagCloud();
            alert("Data JSON berhasil dimuat! (" + Object.keys(dataStore.posts || {}).length + " tanggal, " + Object.keys(dataStore.profileSnapshots || {}).length + " snapshot)");
          } catch(err){
            console.error('loadJson error', err);
            alert("File JSON tidak valid atau terjadi kesalahan parsing: " + (err && err.message ? err.message : 'unknown error'));
          }
        };
        reader.readAsText(file);
      }
      window.loadJson = loadJson;

      // CSV exports
      function exportCsvPostsMode(mode){
        const selectedMonth = document.getElementById("monthFilter")?.value || "all";
        const rows = [["Date","Link","Reach","Impressions","Likes","Comments","Shares","Saves","Engagement Rate","Tags"]];
        Object.keys(dataStore.posts || {}).sort().forEach(date => {
          if (mode==="filter" && selectedMonth!=="all" && !date.startsWith(selectedMonth)) return;
          const p = dataStore.posts[date] || {};
          const items = Array.isArray(p._items) ? p._items : [];
          items.forEach(it => {
            const d = it || {};
            const rate = d.engagement !== undefined ? d.engagement : (d.reach>0?(((d.likes||0)+(d.comments||0)+(d.shares||0)+(d.saves||0))/ (d.reach||1) *100):0);
            rows.push([date, d.link||"", d.reach||0, d.impressions||0, d.likes||0, d.comments||0, d.shares||0, d.saves||0, Number(rate).toFixed(1) + "%", (d.tags||[]).join(' ')]);
          });
        });
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = mode==="filter" ? "posts_filtered.csv" : "posts_all.csv"; a.click();
      }
      window.exportCsvPosts = function(){ exportCsvPostsMode("all"); };
      window.exportCsvPostsFiltered = function(){ exportCsvPostsMode("filter"); };

      function exportCsvProfile(){
        const p = dataStore.profile || {};
        const rows = [
          ["Username","Profile URL","Followers Start","Followers End","Male %","Female %","18-24","25-34","35-44","45-54","55-64"],
          [p.username ? ("@" + normalizeUsername(p.username)) : "", buildProfileURL(p.username||""), p.followersStart||0, p.followersEnd||0, p.gender?.male||0, p.gender?.female||0, p.ageRange?.["18-24"]||0, p.ageRange?.["25-34"]||0, p.ageRange?.["35-44"]||0, p.ageRange?.["45-54"]||0, p.ageRange?.["55-64"]||0]
        ];
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "profile_data.csv"; a.click();
      }
      window.exportCsvProfile = exportCsvProfile;

      // snapshots
      function saveProfileSnapshot(){
        const month = document.getElementById("profileMonthInput")?.value;
        if (!month) return alert("Silakan pilih bulan (YYYY-MM) untuk menyimpan snapshot.");
        const snap = {
          username: normalizeUsername(document.getElementById("username")?.value || ""),
          followersStart: +document.getElementById("followersStart")?.value || 0,
          followersEnd: +document.getElementById("followersEnd")?.value || 0,
          ageRange: {
            "18-24": +document.getElementById("age18_24")?.value || 0,
            "25-34": +document.getElementById("age25_34")?.value || 0,
            "35-44": +document.getElementById("age35_44")?.value || 0,
            "45-54": +document.getElementById("age45_54")?.value || 0,
            "55-64": +document.getElementById("age55_64")?.value || 0
          },
          gender: { male: +document.getElementById("male")?.value || 0, female: +document.getElementById("female")?.value || 0 }
        };
        dataStore.profileSnapshots[month] = snap;
        generateProfileMonthOptions();
        alert("Snapshot profile tersimpan untuk " + month);
      }
      window.saveProfileSnapshot = saveProfileSnapshot;

      function loadProfileSnapshot(){
        const selected = document.getElementById("profileMonthFilter")?.value;
        if (!selected || selected === "all") { renderProfileInputs(); updateProfile(); updateMonthlyReachDisplay(); updateMonthlyImpressionsDisplay(); return; }
        document.getElementById("profileMonthInput").value = selected;
        const snap = dataStore.profileSnapshots[selected];
        if (!snap) { renderProfileInputs(); updateProfile(); updateMonthlyReachDisplay(); updateMonthlyImpressionsDisplay(); return; }
        document.getElementById("username").value = snap.username || "";
        document.getElementById("followersStart").value = snap.followersStart || 0;
        document.getElementById("followersEnd").value = snap.followersEnd || 0;
        document.getElementById("age18_24").value = snap.ageRange?.["18-24"] || 0;
        document.getElementById("age25_34").value = snap.ageRange?.["25-34"] || 0;
        document.getElementById("age35_44").value = snap.ageRange?.["35-44"] || 0;
        document.getElementById("age45_54").value = snap.ageRange?.["45-54"] || 0;
        document.getElementById("age55_64").value = snap.ageRange?.["55-64"] || 0;
        document.getElementById("male").value = snap.gender?.male || 0;
        document.getElementById("female").value = snap.gender?.female || 0;
        renderUsernamePreview();
        updateProfile();
      }
      window.loadProfileSnapshot = loadProfileSnapshot;

      function deleteProfileSnapshot(){
        const selected = document.getElementById("profileMonthFilter")?.value;
        if (!selected || selected === "all") return alert("Pilih snapshot bulan terlebih dahulu.");
        if (!confirm("Hapus snapshot untuk " + selected + " ?")) return;
        delete dataStore.profileSnapshots[selected];
        generateProfileMonthOptions();
        renderProfileInputs();
        updateProfile();
      }
      window.deleteProfileSnapshot = deleteProfileSnapshot;

      // UI init
      function showSaveNotification(msg){
        try {
          const id = 'save-notif';
          let n = document.getElementById(id);
          if (!n) {
            n = document.createElement('div'); n.id = id;
            n.style.position = 'fixed'; n.style.right = '16px'; n.style.top = '16px';
            n.style.background = '#111'; n.style.color = '#fff'; n.style.padding = '10px 14px';
            n.style.borderRadius = '8px'; n.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
            n.style.zIndex = 9999; n.style.fontSize = '13px'; n.style.transition = 'opacity 400ms'; n.style.opacity = '0';
            document.body.appendChild(n);
          }
          n.textContent = msg || 'Tersimpan';
          n.style.opacity = '1';
          if (n._hideTimeout) clearTimeout(n._hideTimeout);
          n._hideTimeout = setTimeout(()=>{ n.style.opacity = '0'; }, 1700);
        } catch(e){}
      }
      window.showSaveNotification = showSaveNotification;

      // wire events on DOMContentLoaded
      document.addEventListener('DOMContentLoaded', function(){
        // inputs
        document.getElementById('dateInput')?.addEventListener('change', handleDateChange);
        ["link","reach","impressions","likes","comments","shares","saves","contentTag","contentNotes","websiteClicks","visit","newPostTitle"].forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.addEventListener('input', function(){ updateEngagement(); scheduleAutoSave(1200); });
        });
        document.getElementById('username')?.addEventListener('input', renderUsernamePreview);
        document.getElementById('profileMonthFilter')?.addEventListener('change', loadProfileSnapshot);
        document.getElementById('monthFilter')?.addEventListener('change', renderTableFiltered);
        document.getElementById('sortField')?.addEventListener('change', function(){ renderTableFiltered(); });
        document.getElementById('sortDir')?.addEventListener('change', function(){ renderTableFiltered(); });
        document.getElementById('tagFilter')?.addEventListener('input', function(){ 
          // sync selectedTags visually and do immediate rendering
          syncSelectedTagsFromFilter();
          renderTableFiltered();
        });
        document.getElementById('applyTableFilterBtn')?.addEventListener('click', function(){ renderTableFiltered(); });

        document.getElementById('jsonFile')?.addEventListener('change', loadJson);

        initCompactObserver();

        // initialize UI from dataStore
        normalizePostsStructure();
        renderProfileInputs();
        renderUsernameAreas();
        generateMonthOptions();
        generateProfileMonthOptions();
        renderTableFiltered();
        updateMonthlyReachDisplay();
        updateMonthlyImpressionsDisplay();
        renderTagCloud();
      });

      // expose some functions globally
      window.renderPostVariantsForDate = renderPostVariantsForDate;
      window.getVariantsForDate = getVariantsForDate;
      window.buildProfileURL = buildProfileURL;
      window.buildProfileText = buildProfileText;
      window.renderProfileInputs = renderProfileInputs;
      window.renderUsernameAreas = renderUsernameAreas;
      window.renderTagCloud = renderTagCloud;
      window.generateMonthOptions = generateMonthOptions;
      window.generateProfileMonthOptions = generateProfileMonthOptions;
      window.updateMonthlyReachDisplay = updateMonthlyReachDisplay;
      window.updateMonthlyImpressionsDisplay = updateMonthlyImpressionsDisplay;
      window.updateEngagement = updateEngagement;
      window.scheduleAutoSave = scheduleAutoSave;
      window.applyCompactSetting = applyCompactSetting;
      window.renderTableFilteredSorted = renderTableFilteredSorted;
      window.saveData = saveData;
      window.loadJson = loadJson;
      window.editData = editData;
      window.deleteData = deleteData;
      window.saveProfileSnapshot = saveProfileSnapshot;
      window.loadProfileSnapshot = loadProfileSnapshot;
      window.deleteProfileSnapshot = deleteProfileSnapshot;
      window.exportJson = exportJson;
      window.selectTagFromTable = selectTagFromTable;
    })();
  </script>
</body>
</html>